# VS Code Marketplace Publishing Guide

**Phase 7.1.7: Marketplace Integration (Option 1 - Hybrid Approach)**

## Overview

The zlsp VS Code extension supports **two installation paths**:

1. **Primary:** Python-based installer (`zlsp-vscode-install`)
2. **Secondary:** VS Code Marketplace (for discoverability)

Both maintain the **single source of truth** architecture and provide identical functionality.

---

## Generating Marketplace Package

```bash
cd /path/to/zlsp
python3 editors/vscode/install.py --marketplace
```

This creates:
```
editors/vscode/marketplace-package/
â”œâ”€â”€ package.json                   # Extension manifest
â”œâ”€â”€ syntaxes/zolo.tmLanguage.json  # TextMate grammar
â”œâ”€â”€ language-configuration.json    # Language settings
â”œâ”€â”€ out/extension.js               # LSP client (with VS Code API)
â”œâ”€â”€ themes/semantic-colors.json    # Bundled theme (40 colors)
â””â”€â”€ README.md                      # User-facing docs
```

---

## Key Differences: Marketplace vs Local Install

| Feature | Python Installer | Marketplace Extension |
|---------|-----------------|----------------------|
| **Entry Point** | `zlsp-vscode-install` | VS Code Marketplace UI |
| **Settings Injection** | File write to `settings.json` | VS Code API (`config.update()`) |
| **Theme Bundling** | Generated on-the-fly | Pre-generated `semantic-colors.json` |
| **LSP Server Check** | Assumes present | Prompts user if missing |
| **npm Dependencies** | Installed locally | Bundled in .vsix |
| **User Steps** | 2 (pip + install) | 2 (marketplace + pip) |

**Both maintain single source of truth:** `themes/zolo_default.yaml`

---

## Marketplace Extension Features

### 1. Auto-Detection
```javascript
// extension.js checks for zolo-lsp on activation
const zoloLspPath = checkZoloLspAvailable();
if (!zoloLspPath) {
    showSetupInstructions(); // Helpful prompt
    return;
}
```

### 2. VS Code API Settings Injection
```javascript
// Uses VS Code API instead of file writes
await config.update(
    'editor.semanticTokenColorCustomizations',
    {
        '[zolo]': {
            enabled: true,
            rules: themeData.rules  // From bundled semantic-colors.json
        }
    },
    vscode.ConfigurationTarget.Global  // Persists globally
);
```

### 3. Bundled Theme
```json
// themes/semantic-colors.json (generated from zolo_default.yaml)
{
  "source": "themes/zolo_default.yaml",
  "generated": "Auto-generated by zlsp theme system",
  "rules": {
    "comment": {"foreground": "#6F6F62", "fontStyle": "italic"},
    "rootKey": {"foreground": "#ffaf87"},
    // ... 38 more token types
  }
}
```

---

## Publishing to Marketplace

### Prerequisites

```bash
# Install vsce (VS Code Extension CLI)
npm install -g @vscode/vsce

# Create publisher account
# https://marketplace.visualstudio.com/manage
```

### Steps

1. **Generate marketplace package:**
   ```bash
   python3 editors/vscode/install.py --marketplace
   ```

2. **Navigate to package directory:**
   ```bash
   cd editors/vscode/marketplace-package
   ```

3. **Install npm dependencies:**
   ```bash
   npm install
   ```

4. **Create .vsix package:**
   ```bash
   vsce package
   # Creates: zolo-lsp-1.0.0.vsix
   ```

5. **Test locally:**
   ```bash
   code --install-extension zolo-lsp-1.0.0.vsix
   # Test with a .zolo file
   ```

6. **Publish to marketplace:**
   ```bash
   vsce publish
   # OR upload manually at:
   # https://marketplace.visualstudio.com/manage/publishers/zolo-ai
   ```

---

## User Experience Comparison

### Python Installer (Current)
```bash
# Step 1: Install zlsp
pip install zlsp

# Step 2: Install VS Code extension
zlsp-vscode-install

# Step 3: Reload VS Code
# Cmd+Shift+P â†’ "Reload Window"

# âœ“ Done! Colors work with any theme!
```

### Marketplace (Future)
```bash
# Step 1: Install from marketplace
# Extensions â†’ Search "Zolo Language Support" â†’ Install

# Step 2: Extension shows prompt
# "Install LSP server: pip install zlsp"
pip install zlsp

# Step 3: Reload VS Code
# Cmd+Shift+P â†’ "Reload Window"

# âœ“ Done! Colors auto-injected via VS Code API!
```

**Both result in the same configuration!**

---

## Architecture: Single Source of Truth Maintained

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ themes/zolo_default.yaml                 â”‚  â† SSOT (One theme file)
â”‚ - 40 semantic token definitions          â”‚
â”‚ - Color palette                          â”‚
â”‚ - Font styles                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
        [VSCodeGenerator]
                 â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                           â†“
[Python]                  [Marketplace]
Generates on-the-fly      Bundles semantic-colors.json
    â†“                           â†“
Writes to file            Writes via VS Code API
    â†“                           â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
      settings.json updated
      (Same 40 token colors)
```

**No duplication, no SSOT violation!**

---

## Maintenance

### Updating Colors

**If you update `themes/zolo_default.yaml`:**

1. Regenerate marketplace package:
   ```bash
   python3 editors/vscode/install.py --marketplace
   ```

2. Publish new version:
   ```bash
   cd editors/vscode/marketplace-package
   vsce package
   vsce publish
   ```

**Both Python installer and marketplace stay in sync automatically!**

---

## FAQ

**Q: Why two installation methods?**  
A: Python installer is primary (full control), marketplace is for discoverability (user convenience).

**Q: Do they duplicate code?**  
A: No! Both generate from same theme (`zolo_default.yaml`). Marketplace bundles pre-generated JSON.

**Q: Which should users use?**  
A: Either! Both maintain SSOT and provide identical results.

**Q: Does marketplace version violate SSOT?**  
A: No! It bundles `semantic-colors.json` generated from canonical theme. Source is still `zolo_default.yaml`.

**Q: Can users switch between methods?**  
A: Yes! Both write to same `settings.json` location, so they're interchangeable.

---

## Testing Marketplace Package

### Local Testing

1. Generate package:
   ```bash
   python3 editors/vscode/install.py --marketplace
   cd editors/vscode/marketplace-package
   npm install
   vsce package
   ```

2. Install locally:
   ```bash
   code --install-extension zolo-lsp-1.0.0.vsix
   ```

3. Test scenarios:
   - âœ… Open .zolo file (should activate extension)
   - âœ… Check Output â†’ "Zolo LSP" (should show logs)
   - âœ… Verify colors match Vim (same theme!)
   - âœ… Test with `zolo-lsp` missing (should show prompt)
   - âœ… Test with `zolo-lsp` present (should work fully)

### Uninstall Testing

**Test VS Code UI uninstall:**
```bash
# Install first
code --install-extension zolo-lsp-1.0.0.vsix

# Uninstall via VS Code UI
code --uninstall-extension zolo-ai.zolo-lsp

# Check: Extension directory removed? (should be YES)
ls ~/.vscode/extensions/ | grep zolo-lsp

# Check: Settings remain? (should be YES - VS Code limitation)
code ~/Library/Application\ Support/Code/User/settings.json
# Look for "[zolo]" section - it will still be there
```

**Test Python uninstaller:**
```bash
# Install first
pip install zlsp
zlsp-vscode-install

# Uninstall with cleanup
zlsp-vscode-uninstall

# Check: Extension removed? (should be YES)
ls ~/.vscode/extensions/ | grep zolo-lsp

# Check: Settings cleaned? (should be YES)
code ~/Library/Application\ Support/Code/User/settings.json
# "[zolo]" section should be gone

# Check: Backup created? (should be YES)
ls ~/Library/Application\ Support/Code/User/ | grep settings.json.backup
```

**Expected Behavior:**
- âœ… VS Code UI: Removes extension, leaves settings (industry standard)
- âœ… Python uninstaller: Removes extension AND settings (complete cleanup)

---

## Success Metrics

- âœ… **SSOT Maintained**: Both paths use `zolo_default.yaml` as source
- âœ… **Zero Config**: Both require no manual theme activation
- âœ… **Identical Colors**: Vim = Python Install = Marketplace
- âœ… **User Friendly**: Clear prompts when LSP missing
- âœ… **Discoverable**: Marketplace listing for new users
- âœ… **Maintainable**: Single theme update â†’ both paths updated

---

**Phase 7.1.7 Complete!** ğŸ‰

Marketplace package ready for publishing. Both installation paths maintain zlsp's architectural integrity.
