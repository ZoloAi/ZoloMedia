// Generated by zlsp installer - DO NOT EDIT
// This file activates the Zolo LSP client

const vscode = require('vscode');
const path = require('path');
const fs = require('fs');
const { LanguageClient } = require('vscode-languageclient/node');

let client;
let outputChannel;

/**
 * Check if zolo-lsp command is available
 */
function checkZoloLspAvailable() {
    const { execSync } = require('child_process');
    try {
        const zoloLspPath = execSync('which zolo-lsp || where zolo-lsp', { 
            encoding: 'utf8',
            stdio: ['pipe', 'pipe', 'ignore'] // Suppress stderr
        }).trim();
        return zoloLspPath ? zoloLspPath : null;
    } catch (err) {
        return null;
    }
}

/**
 * Show setup instructions when LSP server is missing
 */
async function showSetupInstructions() {
    const choice = await vscode.window.showWarningMessage(
        'Zolo LSP server not found. Install it to enable semantic highlighting and LSP features.',
        'Open Terminal',
        'View Instructions',
        'Dismiss'
    );
    
    if (choice === 'Open Terminal') {
        const terminal = vscode.window.createTerminal('Zolo LSP Setup');
        terminal.show();
        terminal.sendText('# Install Zolo LSP server:');
        terminal.sendText('pip install zlsp');
        terminal.sendText('# Then reload VS Code');
    } else if (choice === 'View Instructions') {
        vscode.env.openExternal(vscode.Uri.parse('https://github.com/zolomedia/zlsp#installation'));
    }
}


/**
 * Inject semantic token colors into user settings (Marketplace version)
 * Uses VS Code API to maintain single source of truth from bundled theme
 */
async function injectSemanticTokenColors(context) {
    try {
        // Load theme from bundled YAML file
        const themeYamlPath = path.join(context.extensionPath, 'themes', 'zolo_default.yaml');
        
        // For marketplace, we load pre-generated JSON instead
        const themeJsonPath = path.join(context.extensionPath, 'themes', 'semantic-colors.json');
        
        if (!fs.existsSync(themeJsonPath)) {
            outputChannel.appendLine('⚠ Theme JSON not found, skipping settings injection');
            return false;
        }
        
        const themeData = JSON.parse(fs.readFileSync(themeJsonPath, 'utf8'));
        
        // Get current configuration
        const config = vscode.workspace.getConfiguration();
        const existingCustomizations = config.get('editor.semanticTokenColorCustomizations') || {};
        
        // Clean up old theme-scoped '[zolo]' section from previous installations
        const cleanedCustomizations = { ...existingCustomizations };
        if (cleanedCustomizations['[zolo]']) {
            delete cleanedCustomizations['[zolo]'];
            outputChannel.appendLine("ℹ️  Cleaned up old '[zolo]' theme-scoped colors");
        }
        
        // Check if already configured (global rules)
        if (cleanedCustomizations.rules && Object.keys(themeData.rules).every(key => key in cleanedCustomizations.rules)) {
            outputChannel.appendLine('✓ Semantic token colors already configured');
            return true;
        }
        
        // Inject Zolo semantic token colors globally (works with ANY theme)
        const updatedCustomizations = {
            ...cleanedCustomizations,
            enabled: true,
            rules: {
                ...(cleanedCustomizations.rules || {}),
                ...themeData.rules
            }
        };
        
        // Update global configuration (persists across sessions)
        await config.update(
            'editor.semanticTokenColorCustomizations',
            updatedCustomizations,
            vscode.ConfigurationTarget.Global
        );
        
        outputChannel.appendLine('✓ Injected ' + Object.keys(themeData.rules).length + ' semantic token color rules (global scope)');
        outputChannel.appendLine('  Works with ANY VS Code theme!');
        outputChannel.appendLine('  Settings will persist across all VS Code sessions');
        
        return true;
    } catch (err) {
        outputChannel.appendLine('✗ Failed to inject settings: ' + err.message);
        return false;
    }
}

function activate(context) {
    // Create output channel for debugging
    outputChannel = vscode.window.createOutputChannel('Zolo LSP');
    outputChannel.appendLine('=== Zolo LSP Extension Activating ===');
    outputChannel.appendLine('Timestamp: ' + new Date().toISOString());
    outputChannel.appendLine('Mode: Marketplace installation');
    
    // Inject semantic token colors automatically (Marketplace mode)
    injectSemanticTokenColors(context).then(success => {
        if (success) {
            outputChannel.appendLine('✓ Semantic token colors configured via VS Code API');
        }
    });
    
    // Check if zolo-lsp is available
    const zoloLspPath = checkZoloLspAvailable();
    
    if (!zoloLspPath) {
        outputChannel.appendLine('✗ ERROR: zolo-lsp not found in PATH!');
        outputChannel.appendLine('  Install with: pip install zlsp');
        outputChannel.appendLine('  Then reload VS Code: Cmd+Shift+P → Reload Window');
        
        // Show user-friendly setup instructions
        showSetupInstructions();
        return;
    }
    
    outputChannel.appendLine('✓ Found zolo-lsp at: ' + zoloLspPath);
    
    // LSP server options (points to zolo-lsp command)
    const serverOptions = {
        command: 'zolo-lsp',
        args: [],
        options: {
            env: process.env
        }
    };
    
    outputChannel.appendLine('Server command: zolo-lsp');
    
    // Get trace setting from VS Code configuration
    const config = vscode.workspace.getConfiguration('zolo');
    const traceLevel = config.get('trace.server', 'messages');
    outputChannel.appendLine('Trace level: ' + traceLevel);
    
    // Client options (file patterns, synchronization, output channel)
    const clientOptions = {
        documentSelector: [{ scheme: 'file', language: 'zolo' }],
        synchronize: {
            fileEvents: vscode.workspace.createFileSystemWatcher('**/*.zolo')
        },
        outputChannel: outputChannel,
        traceOutputChannel: outputChannel,
        revealOutputChannelOn: 1, // RevealOutputChannelOn.Info (show on any message)
        initializationOptions: {
            trace: traceLevel
        },
        middleware: {
            // Log semantic token requests/responses
            provideDocumentSemanticTokens: async (document, token, next) => {
                outputChannel.appendLine('→ Requesting semantic tokens for: ' + document.fileName);
                const result = await next(document, token);
                if (result) {
                    outputChannel.appendLine('✓ Received semantic tokens (data length: ' + (result.data ? result.data.length : 0) + ')');
                } else {
                    outputChannel.appendLine('✗ No semantic tokens received');
                }
                return result;
            }
        }
    };
    
    outputChannel.appendLine('Creating LSP client...');
    
    // Create and start the LSP client
    client = new LanguageClient(
        'zoloLsp',
        'Zolo Language Server',
        serverOptions,
        clientOptions
    );
    
    // Log client state changes
    client.onDidChangeState((event) => {
        outputChannel.appendLine('LSP State changed: ' + JSON.stringify({
            oldState: event.oldState,
            newState: event.newState
        }));
    });
    
    outputChannel.appendLine('Starting LSP client...');
    
    client.start().then(() => {
        outputChannel.appendLine('✓ LSP client started successfully');
        outputChannel.appendLine('');
        outputChannel.appendLine('Semantic Token Legend:');
        client.initializeResult?.capabilities?.semanticTokensProvider?.legend?.tokenTypes?.forEach((type, i) => {
            outputChannel.appendLine('  ' + i + ': ' + type);
        });
    }).catch((err) => {
        outputChannel.appendLine('✗ Failed to start LSP client: ' + err);
        vscode.window.showErrorMessage('Zolo LSP failed to start: ' + err.message);
    });
    
    // Register command to show output
    context.subscriptions.push(
        vscode.commands.registerCommand('zolo.showOutput', () => {
            outputChannel.show();
        })
    );
}

function deactivate() {
    if (outputChannel) {
        outputChannel.appendLine('=== Zolo LSP Extension Deactivating ===');
    }
    if (!client) {
        return undefined;
    }
    return client.stop();
}

module.exports = {
    activate,
    deactivate
};
